<launch>
  <!--px4 environment variables-->
  <env name="PX4_SIM_SPEED_FACTOR" value="1"/>
  <arg name="cam_deg" default="0"/>
  <!-- gazebo configs -->
  <arg name="gui" default="true"/>
  <arg name="debug" default="false"/>
  <arg name="verbose" default="true"/>
  <arg name="paused" default="false"/>
  <arg name="interactive" default="false"/>
  <arg name="world" default="$(find auav_2022_sample)/worlds/trial_1.world"/>
  <arg name="lockstep" default="true"/>

  <!-- tf frames -->
  <node pkg="tf2_ros" type="static_transform_publisher" name="tf_odom_map"
    args="0 0 0 0 0 0 map odom "/>
  <node pkg="tf2_ros" type="static_transform_publisher" name="tf_base_link_camera"
    args="0 0 0 -1.57 0 -1.57 base_link camera_link"/>
  <!--<node pkg="tf" type="static_transform_publisher" name="tf_base_link_fcu"-->
    <!--args="0 0 0 0 0 0 base_link fcu 10"/>-->
  <!--<node pkg="tf" type="static_transform_publisher" name="tf_local_origin_map"-->
    <!--args="0 0 0 0 0 0 local_origin map 10"/>-->

  <!-- Launch rqt_reconfigure -->
  <!--<node pkg="rqt_reconfigure" type="rqt_reconfigure" output="log" name="rqt_reconfigure" />-->

  <!-- rviz -->
  <node name="rviz" pkg="rviz" type="rviz" output="log" args="-d $(find auav_2022_sample)/config/local_planner.rviz" />
	
  <!--referee to compute score -->
  <node name="referee" pkg="auav_2022_sample" type="referee.py" output="log">
    <remap from="trial_running" to="/drone/trial_running"/>
    <remap from="rover" to="/qualisys/rover/odom"/>
    <remap from="drone" to="/qualisys/drone/odom"/>
  </node>

  <!--gazebo-->
  <include file="$(find gazebo_ros)/launch/empty_world.launch">
      <arg name="gui" value="$(arg gui)"/>
      <arg name="world_name" value="$(arg world)"/>
      <arg name="debug" value="$(arg debug)"/>
      <arg name="verbose" value="$(arg verbose)"/>
      <arg name="paused" value="$(arg paused)"/>
      <arg name="respawn_gazebo" value="false"/>
      <arg unless="$(arg lockstep)" name="extra_gazebo_args" value=""/>
      <arg     if="$(arg lockstep)" name="extra_gazebo_args" value="--lockstep"/>
  </include>

  <!-- rviz -->
  <!--node name="rviz" pkg="rviz" type="rviz" output="log" args="-d $(find auav_2022_sample)/config/local_planner.rviz" /-->

  <!-- start distration rover  -->
  <group ns="axial_scx10" clear_params="true">

    <node name="rover_teleop" pkg="teleop_twist_keyboard" type="teleop_twist_keyboard.py" output="screen" launch-prefix="xterm -e">
      <remap from='cmd_vel' to='/axial_scx10/cmd_vel'/>
    </node>

  </group>


  <!-- start rover  -->
  <group ns="rover" clear_params="true">

    <!--qualiysis -->
    <node name="odom_to_tf" pkg="auav_2022_sample" type="odom_to_tf.py" output="log">
      <remap from="odom" to="/qualisys/rover/odom"/>
      <param name="child_frame_override" value="rover"/>
    </node>

    <!--scripted rover control-->
    <node name="skidsteer_controller" pkg="auav_2022_sample" type="skidsteer_controller.py" output="screen">
      <param name="vehicle_frame" value="rover"/>
      <param name="map_frame" value="map"/>
      <param name="mode" value="reference"/>
      <param name="delay" value="0"/>
      <param name="v_max" value="0.2"/>
      <param name="omega_max" value="0.3"/>
      <remap from="cmd_vel" to="/rover/cmd_vel"/>
      <remap from="trial_running" to="/drone/trial_running"/>
    </node>
  </group>

  <!-- start drone  -->
  <group ns="drone" clear_params="true">

    <arg name="cam_rad" default="$(eval -1.5708 - cam_deg*3.1416/180)"/>

    <!--topic relay for mocap-->
    <node pkg="topic_tools" type="relay" name="relay" output="log" args="/qualisys/drone/odom /drone/mavros/odometry/out"/>

    <!-- tf frames -->
    <node name="tf_odom_map" pkg="tf2_ros" type="static_transform_publisher"
      args="0 0 0 0 0 0 map odom "/>
    <node name="tf_base_link_camera" pkg="tf2_ros" type="static_transform_publisher"
      args="0 0 0 -1.57 0 $(arg cam_rad) base_link camera_link"/>

    <!--qualiysis -->
    <node name="odom_to_tf" pkg="auav_2022_sample" type="odom_to_tf.py" output="log">
      <remap from="odom" to="/qualisys/drone/odom"/>
      <param name="child_frame_override" value="drone"/>
    </node>

    <!--px4 environment variables-->
    <env name="PX4_HOME_LAT" value="40.41536" />
    <env name="PX4_HOME_LON" value="-86.93288" />
    <env name="PX4_HOME_ALT" value="182" />
    <env name="PX4_SIM_MODEL" value="iris" />
    <env name="PX4_ESTIMATOR" value="ekf2" />
   
    <!--px4 software in the loop-->
   <node name="sitl" pkg="px4" type="px4" output="screen" launch-prefix="xterm -e"
      args="$(find px4)/../../../build/px4/etc -s etc/init.d-posix/rcS" required="true"/>

    <!-- mavros -->
    <node pkg="mavros" type="mavros_node" name="mavros" required="true" clear_params="true" output="log">
      <param name="fcu_url" value="udp://:14540@localhost:14557" />
      <param name="gcs_url" value="" />
      <param name="target_system_id" value="1" />
      <param name="target_component_id" value="1" />
      <param name="fcu_protocol" value="v2.0" />
      <!-- load blacklist, config -->
      <rosparam command="load" file="$(find auav_2022_sample)/launch/px4_pluginlists.yaml" />
      <rosparam command="load" file="$(find auav_2022_sample)/launch/px4_config.yaml" />
    </node>


	<node pkg="octomap_server" type="octomap_server_node" name="octomap_server" output="log" launch-prefix="bash -c 'sleep 20; $0 $@'">
      <param name="base_frame_id" value="drone"/>
      <remap from="cloud_in" to="camera/depth/points"/>
      <param name="resolution" value="0.3"/>
      <param name="frame_id" type="string" value="map"/>
      <param name="sensor_model/max_range" value="10.0"/>
		
      <param name="pointcloud_min_z" value="0.4"/>
      <param name="pointcloud_max_z" value="3.0"/>
    </node>
	  
  </group>


</launch>

<!-- vim set ft=xml ts=2 sw=2 et: -->
